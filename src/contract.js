const forwarderOrigin = "http://localhost:9010";
const Web3 = require("web3");
const MetaMaskOnboarding = require("@metamask/onboarding");

const initialize = () => {
  //Basic Actions Section
  const onboardButton = document.getElementById("connectButton");
  const chainIdlabel = document.getElementById("chainId");
  const networkLabel = document.getElementById("network");
  const contractStatus = document.getElementById("contractStatus");


  //Contract Deployment Section
  const tokenAddress = document.getElementById("tokenAddress");
  const createToken = document.getElementById("createToken");
  const deployButton = document.getElementById("deployButton");
  const deployedTokenAddress = document.getElementById("deployedTokenAddress");
  const deployUsingInput = document.getElementById("deployUsingInput");
  const approve = document.getElementById("approve");
  const exisitngVaultAddress = document.getElementById("exisitngVaultAddress");
  const loadVault = document.getElementById("loadVault");

  //Manage Grant Section
  const setGrantAmount = document.getElementById("setGrantAmount");
  const setGrantAddress = document.getElementById("setGrantAddress");
  const setDays = document.getElementById("setDays");
  const createNewGrant = document.getElementById("createNewGrant");
  const granteeAddress = document.getElementById("granteeAddress");
  const revokeGrant = document.getElementById("revokeGrant");

  //Claim Vested Grant Section
  const fetchGrant = document.getElementById("fetchGrant");
  const claimGrant = document.getElementById("claimGrant");
  const lockedGrant = document.getElementById("lockedGrant");
  const unlockedGrant = document.getElementById("unlockedGrant");
  const alreadyClaimed = document.getElementById("alreadyClaimed");


  //Created check function to see if the MetaMask extension is installed
  const isMetaMaskInstalled = () => {
    //Have to check the ethereum binding on the window object to see if it's installed
    const { ethereum } = window;
    return Boolean(ethereum && ethereum.isMetaMask);
  };

  //We create a new MetaMask onboarding object to use in our app
  const onboarding = new MetaMaskOnboarding({ forwarderOrigin });

  //This will start the onboarding proccess
  const onClickInstall = () => {
    onboardButton.innerText = "Onboarding in progress";
    onboardButton.disabled = true;
    //On this object we have startOnboarding which will start the onboarding process for our end user
    onboarding.startOnboarding();
  };

  const onClickConnect = async () => {
    try {
      // Will open the MetaMask UI
      // You should disable this button while the request is pending!
      await ethereum.request({ method: "eth_requestAccounts" });
      const accounts = await ethereum.request({ method: "eth_accounts" });
      onboardButton.innerText = accounts[0];
      onboardButton.disabled = true;
    } catch (error) {
      console.error(error);
    }
  };

  const onboardButtonUpdate = async (accounts) => {
    onboardButton.innerText = accounts[0];
    onboardButton.disabled = true;
  };

  const MetaMaskClientCheck = async () => {
    //Now we check to see if Metmask is installed
    if (!isMetaMaskInstalled()) {
      //If it isn't installed we ask the user to click to install it
      onboardButton.innerText = "Click here to install MetaMask!";
      //When the button is clicked we call th is function
      onboardButton.onclick = onClickInstall;
      //The button is now disabled
      onboardButton.disabled = false;
    } else {
      //If MetaMask is installed we ask the user to connect to their wallet
      onboardButton.innerText = "Connect";
      //When the button is clicked we call this function to connect the users MetaMask Wallet
      onboardButton.onclick = onClickConnect;
      //The button is now disabled
      onboardButton.disabled = false;
    }

    const accounts = await ethereum.request({ method: "eth_accounts" });

    if (accounts[0]) {
      onboardButtonUpdate(accounts);
    }

    if (ethereum) {
      const chainId = await ethereum.request({ method: "eth_chainId" });
      chainIdlabel.innerHTML = parseInt(chainId, 16);
      networkLabel.innerHTML = chainIdtoName(parseInt(chainId, 16));

      ethereum.on("chainChanged", (chainId) => {
        // Handle the new chain.
        // Correctly handling chain changes can be complicated.
        // We recommend reloading the page unless you have good reason not to.
        window.location.reload();
      });

      ethereum.on("accountsChanged", (accounts) => {
        // Handle the new accounts, or lack thereof.
        // 'accounts' will always be an array, but it can be empty.

        if (accounts.length === 0) {
          window.location.reload();
        } else {
          onboardButtonUpdate(accounts);
        }
      });

      window.web3 = new Web3(window.ethereum);
    }
  };

  // chainIdtoName is a map list to attribute each chain ID to
  // a specific chain name. A full chain id and name list can be found
  // at https://github.com/DefiLlama/chainlist/blob/main/components/chains.js

  function chainIdtoName(chainId) {
    var chainlist_map = [];

    chainlist_map[1] = "Ethereum Mainnet";
    chainlist_map[3] = "Ropsten Testnet";
    chainlist_map[56] = "BSC Mainnet";
    chainlist_map[97] = "BSC Testnet";
    chainlist_map[137] = "Polygon Mainnet";
    chainlist_map[1337] = "Ganache";


    return chainlist_map[chainId];
    
  }

  chainIdtoName(chainId);
  
  MetaMaskClientCheck();

  web3 = new Web3(window.web3.currentProvider);
  const tokenABI = [ { "inputs": [ { "internalType": "string", "name": "name_", "type": "string" }, { "internalType": "string", "name": "symbol_", "type": "string" }, { "internalType": "uint256", "name": "initialSupply_", "type": "uint256" } ], "stateMutability": "nonpayable", "type": "constructor" }, { "anonymous": false, "inputs": [ { "indexed": true, "internalType": "address", "name": "owner", "type": "address" }, { "indexed": true, "internalType": "address", "name": "spender", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "value", "type": "uint256" } ], "name": "Approval", "type": "event" }, { "anonymous": false, "inputs": [ { "indexed": true, "internalType": "address", "name": "previousOwner", "type": "address" }, { "indexed": true, "internalType": "address", "name": "newOwner", "type": "address" } ], "name": "OwnershipTransferred", "type": "event" }, { "anonymous": false, "inputs": [ { "indexed": true, "internalType": "address", "name": "from", "type": "address" }, { "indexed": true, "internalType": "address", "name": "to", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "value", "type": "uint256" } ], "name": "Transfer", "type": "event" }, { "inputs": [ { "internalType": "address", "name": "owner", "type": "address" }, { "internalType": "address", "name": "spender", "type": "address" } ], "name": "allowance", "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "stateMutability": "view", "type": "function" }, { "inputs": [ { "internalType": "address", "name": "spender", "type": "address" }, { "internalType": "uint256", "name": "amount", "type": "uint256" } ], "name": "approve", "outputs": [ { "internalType": "bool", "name": "", "type": "bool" } ], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [ { "internalType": "address", "name": "account", "type": "address" } ], "name": "balanceOf", "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "stateMutability": "view", "type": "function" }, { "inputs": [ { "internalType": "uint256", "name": "amount", "type": "uint256" } ], "name": "burn", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [ { "internalType": "address", "name": "account", "type": "address" }, { "internalType": "uint256", "name": "amount", "type": "uint256" } ], "name": "burnFrom", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "decimals", "outputs": [ { "internalType": "uint8", "name": "", "type": "uint8" } ], "stateMutability": "view", "type": "function" }, { "inputs": [ { "internalType": "address", "name": "spender", "type": "address" }, { "internalType": "uint256", "name": "subtractedValue", "type": "uint256" } ], "name": "decreaseAllowance", "outputs": [ { "internalType": "bool", "name": "", "type": "bool" } ], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [ { "internalType": "address", "name": "spender", "type": "address" }, { "internalType": "uint256", "name": "addedValue", "type": "uint256" } ], "name": "increaseAllowance", "outputs": [ { "internalType": "bool", "name": "", "type": "bool" } ], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "name", "outputs": [ { "internalType": "string", "name": "", "type": "string" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "owner", "outputs": [ { "internalType": "address", "name": "", "type": "address" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "renounceOwnership", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "symbol", "outputs": [ { "internalType": "string", "name": "", "type": "string" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "totalSupply", "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "stateMutability": "view", "type": "function" }, { "inputs": [ { "internalType": "address", "name": "recipient", "type": "address" }, { "internalType": "uint256", "name": "amount", "type": "uint256" } ], "name": "transfer", "outputs": [ { "internalType": "bool", "name": "", "type": "bool" } ], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [ { "internalType": "address", "name": "sender", "type": "address" }, { "internalType": "address", "name": "recipient", "type": "address" }, { "internalType": "uint256", "name": "amount", "type": "uint256" } ], "name": "transferFrom", "outputs": [ { "internalType": "bool", "name": "", "type": "bool" } ], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [ { "internalType": "address", "name": "newOwner", "type": "address" } ], "name": "transferOwnership", "outputs": [], "stateMutability": "nonpayable", "type": "function" } ];
  const contractABI = [ { "inputs": [ { "internalType": "contract ERC20", "name": "_token", "type": "address" } ], "stateMutability": "nonpayable", "type": "constructor" }, { "anonymous": false, "inputs": [ { "indexed": true, "internalType": "address", "name": "recipient", "type": "address" } ], "name": "GrantAdded", "type": "event" }, { "anonymous": false, "inputs": [ { "indexed": false, "internalType": "address", "name": "recipient", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "amountVested", "type": "uint256" }, { "indexed": false, "internalType": "uint256", "name": "amountNotVested", "type": "uint256" } ], "name": "GrantRevoked", "type": "event" }, { "anonymous": false, "inputs": [ { "indexed": true, "internalType": "address", "name": "recipient", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "amountClaimed", "type": "uint256" } ], "name": "GrantTokensClaimed", "type": "event" }, { "anonymous": false, "inputs": [ { "indexed": true, "internalType": "address", "name": "previousOwner", "type": "address" }, { "indexed": true, "internalType": "address", "name": "newOwner", "type": "address" } ], "name": "OwnershipTransferred", "type": "event" }, { "inputs": [], "name": "owner", "outputs": [ { "internalType": "address", "name": "", "type": "address" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "renounceOwnership", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "token", "outputs": [ { "internalType": "contract ERC20", "name": "", "type": "address" } ], "stateMutability": "view", "type": "function" }, { "inputs": [ { "internalType": "address", "name": "newOwner", "type": "address" } ], "name": "transferOwnership", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [ { "internalType": "address", "name": "_recipient", "type": "address" }, { "internalType": "uint256", "name": "_amount", "type": "uint256" }, { "internalType": "uint16", "name": "_vestingDurationInDays", "type": "uint16" }, { "internalType": "uint16", "name": "_vestingCliffInDays", "type": "uint16" } ], "name": "addTokenGrant", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "claimVestedTokens", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [ { "internalType": "address", "name": "_recipient", "type": "address" } ], "name": "revokeTokenGrant", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [ { "internalType": "address", "name": "_recipient", "type": "address" } ], "name": "getGrantAmount", "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "stateMutability": "view", "type": "function" }, { "inputs": [ { "internalType": "address", "name": "_recipient", "type": "address" } ], "name": "calculateGrantClaim", "outputs": [ { "internalType": "uint16", "name": "", "type": "uint16" }, { "internalType": "uint256", "name": "", "type": "uint256" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "fetchGrantData", "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "stateMutability": "view", "type": "function" } ];
  
  window.token = new web3.eth.Contract(tokenABI);
  window.contract = new web3.eth.Contract(contractABI);
  
  //
  // Deploy New VestingVault Section
  //
  createToken.onclick = async () => {
    contractStatus.innerHTML = "Deploying Test Token";
    const accounts = await ethereum.request({ method: "eth_accounts" });

    await window.token
      .deploy({
        data: "60806040526003805460ff191660121790553480156200001e57600080fd5b506040516200122d3803806200122d833981810160405260608110156200004457600080fd5b81019080805160405193929190846401000000008211156200006557600080fd5b9083019060208201858111156200007b57600080fd5b82516401000000008111828201881017156200009657600080fd5b82525081516020918201929091019080838360005b83811015620000c5578181015183820152602001620000ab565b50505050905090810190601f168015620000f35780820380516001836020036101000a031916815260200191505b50604052602001805160405193929190846401000000008211156200011757600080fd5b9083019060208201858111156200012d57600080fd5b82516401000000008111828201881017156200014857600080fd5b82525081516020918201929091019080838360005b83811015620001775781810151838201526020016200015d565b50505050905090810190601f168015620001a55780820380516001836020036101000a031916815260200191505b5060405260200151915060009050620001bd62000288565b600080546001600160a01b0319166001600160a01b0383169081178255604051929350917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e0908290a35081516200021c9060029060208501906200028c565b508251620002329060019060208601906200028c565b503360008181526005602090815260408083208590556004859055805185815290517fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef929181900390910190a350505062000338565b3390565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282620002c457600085556200030f565b82601f10620002df57805160ff19168380011785556200030f565b828001600101855582156200030f579182015b828111156200030f578251825591602001919060010190620002f2565b506200031d92915062000321565b5090565b5b808211156200031d576000815560010162000322565b610ee580620003486000396000f3fe608060405234801561001057600080fd5b50600436106101005760003560e01c8063715018a611610097578063a457c2d711610066578063a457c2d714610301578063a9059cbb1461032d578063dd62ed3e14610359578063f2fde38b1461038757610100565b8063715018a6146102a157806379cc6790146102a95780638da5cb5b146102d557806395d89b41146102f957610100565b8063313ce567116100d3578063313ce56714610212578063395093511461023057806342966c681461025c57806370a082311461027b57610100565b806306fdde0314610105578063095ea7b31461018257806318160ddd146101c257806323b872dd146101dc575b600080fd5b61010d6103ad565b6040805160208082528351818301528351919283929083019185019080838360005b8381101561014757818101518382015260200161012f565b50505050905090810190601f1680156101745780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6101ae6004803603604081101561019857600080fd5b506001600160a01b038135169060200135610442565b604080519115158252519081900360200190f35b6101ca61045f565b60408051918252519081900360200190f35b6101ae600480360360608110156101f257600080fd5b506001600160a01b03813581169160208101359091169060400135610465565b61021a6104ec565b6040805160ff9092168252519081900360200190f35b6101ae6004803603604081101561024657600080fd5b506001600160a01b0381351690602001356104f5565b6102796004803603602081101561027257600080fd5b5035610543565b005b6101ca6004803603602081101561029157600080fd5b50356001600160a01b0316610557565b610279610572565b610279600480360360408110156102bf57600080fd5b506001600160a01b038135169060200135610626565b6102dd610680565b604080516001600160a01b039092168252519081900360200190f35b61010d61068f565b6101ae6004803603604081101561031757600080fd5b506001600160a01b0381351690602001356106ed565b6101ae6004803603604081101561034357600080fd5b506001600160a01b038135169060200135610755565b6101ca6004803603604081101561036f57600080fd5b506001600160a01b0381358116916020013516610769565b6102796004803603602081101561039d57600080fd5b50356001600160a01b0316610794565b60018054604080516020601f600260001961010087891615020190951694909404938401819004810282018101909252828152606093909290918301828280156104385780601f1061040d57610100808354040283529160200191610438565b820191906000526020600020905b81548152906001019060200180831161041b57829003601f168201915b5050505050905090565b600061045661044f61089e565b84846108a2565b50600192915050565b60045490565b600061047284848461098e565b6104e28461047e61089e565b6104dd85604051806060016040528060288152602001610dd5602891396001600160a01b038a166000908152600660205260408120906104bc61089e565b6001600160a01b031681526020810191909152604001600020549190610aeb565b6108a2565b5060019392505050565b60035460ff1690565b600061045661050261089e565b846104dd856006600061051361089e565b6001600160a01b03908116825260208083019390935260409182016000908120918c168152925290205490610b82565b61055461054e61089e565b82610be3565b50565b6001600160a01b031660009081526005602052604090205490565b61057a61089e565b6000546001600160a01b039081169116146105dc576040805162461bcd60e51b815260206004820181905260248201527f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e6572604482015290519081900360640190fd5b600080546040516001600160a01b03909116907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e0908390a3600080546001600160a01b0319169055565b600061065d82604051806060016040528060248152602001610dfd602491396106568661065161089e565b610769565b9190610aeb565b90506106718361066b61089e565b836108a2565b61067b8383610be3565b505050565b6000546001600160a01b031690565b60028054604080516020601f60001961010060018716150201909416859004938401819004810282018101909252828152606093909290918301828280156104385780601f1061040d57610100808354040283529160200191610438565b60006104566106fa61089e565b846104dd85604051806060016040528060258152602001610e8b602591396006600061072461089e565b6001600160a01b03908116825260208083019390935260409182016000908120918d16815292529020549190610aeb565b600061045661076261089e565b848461098e565b6001600160a01b03918216600090815260066020908152604080832093909416825291909152205490565b61079c61089e565b6000546001600160a01b039081169116146107fe576040805162461bcd60e51b815260206004820181905260248201527f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e6572604482015290519081900360640190fd5b6001600160a01b0381166108435760405162461bcd60e51b8152600401808060200182810382526026815260200180610d676026913960400191505060405180910390fd5b600080546040516001600160a01b03808516939216917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e091a3600080546001600160a01b0319166001600160a01b0392909216919091179055565b3390565b6001600160a01b0383166108e75760405162461bcd60e51b8152600401808060200182810382526024815260200180610e676024913960400191505060405180910390fd5b6001600160a01b03821661092c5760405162461bcd60e51b8152600401808060200182810382526022815260200180610d8d6022913960400191505060405180910390fd5b6001600160a01b03808416600081815260066020908152604080832094871680845294825291829020859055815185815291517f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b9259281900390910190a3505050565b6001600160a01b0383166109d35760405162461bcd60e51b8152600401808060200182810382526025815260200180610e426025913960400191505060405180910390fd5b6001600160a01b038216610a185760405162461bcd60e51b8152600401808060200182810382526023815260200180610d226023913960400191505060405180910390fd5b610a2383838361067b565b610a6081604051806060016040528060268152602001610daf602691396001600160a01b0386166000908152600560205260409020549190610aeb565b6001600160a01b038085166000908152600560205260408082209390935590841681522054610a8f9082610b82565b6001600160a01b0380841660008181526005602090815260409182902094909455805185815290519193928716927fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef92918290030190a3505050565b60008184841115610b7a5760405162461bcd60e51b81526004018080602001828103825283818151815260200191508051906020019080838360005b83811015610b3f578181015183820152602001610b27565b50505050905090810190601f168015610b6c5780820380516001836020036101000a031916815260200191505b509250505060405180910390fd5b505050900390565b600082820183811015610bdc576040805162461bcd60e51b815260206004820152601b60248201527f536166654d6174683a206164646974696f6e206f766572666c6f770000000000604482015290519081900360640190fd5b9392505050565b6001600160a01b038216610c285760405162461bcd60e51b8152600401808060200182810382526021815260200180610e216021913960400191505060405180910390fd5b610c348260008361067b565b610c7181604051806060016040528060228152602001610d45602291396001600160a01b0385166000908152600560205260409020549190610aeb565b6001600160a01b038316600090815260056020526040902055600454610c979082610cdf565b6004556040805182815290516000916001600160a01b038516917fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef9181900360200190a35050565b6000610bdc83836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f770000815250610aeb56fe45524332303a207472616e7366657220746f20746865207a65726f206164647265737345524332303a206275726e20616d6f756e7420657863656564732062616c616e63654f776e61626c653a206e6577206f776e657220697320746865207a65726f206164647265737345524332303a20617070726f766520746f20746865207a65726f206164647265737345524332303a207472616e7366657220616d6f756e7420657863656564732062616c616e636545524332303a207472616e7366657220616d6f756e74206578636565647320616c6c6f77616e636545524332303a206275726e20616d6f756e74206578636565647320616c6c6f77616e636545524332303a206275726e2066726f6d20746865207a65726f206164647265737345524332303a207472616e736665722066726f6d20746865207a65726f206164647265737345524332303a20617070726f76652066726f6d20746865207a65726f206164647265737345524332303a2064656372656173656420616c6c6f77616e63652062656c6f77207a65726fa26469706673582212204e216be23843b0a0cd80fedd3713322dfc84e48e4c6e4ccc8eb164fe42a6c97564736f6c63430007060033",
        arguments: ['TOKEN', 'TKN', web3.utils.toWei('100000', 'ether')],
      })
      .send({
        from: accounts[0],
        gas: "1200000",
      })
      .on("error", function (error) {
        console.log(error);
        contractStatus.innerHTML = "Deployment Failed";
      })
      .on("confirmation", function (confirmationNumber, receipt) {
        if (confirmationNumber < 1) {
          console.log(confirmationNumber);
          console.log(receipt);
          contractStatus.innerHTML = "Contract Deployed";
        }
        createToken.disabled = true;
        deployButton.disabled = false;
      })
      .then(function (newContractInstance) {
        window.token.options.address = newContractInstance.options.address;
        tokenAddress.innerHTML = newContractInstance.options.address;
      });
  };

  deployButton.onclick = async () => {
    contractStatus.innerHTML = "Deploying";
    const accounts = await ethereum.request({ method: "eth_accounts" });

    await window.contract
      .deploy({
        data: "0x608060405234801561001057600080fd5b506040516111b03803806111b08339818101604052602081101561003357600080fd5b505160006100486401000000006100ca810204565b60008054600160a060020a031916600160a060020a0383169081178255604051929350917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e0908290a350600160a060020a0381166100a557600080fd5b60018054600160a060020a031916600160a060020a03929092169190911790556100ce565b3390565b6110d3806100dd6000396000f3fe608060405234801561001057600080fd5b50600436106100a25760003560e060020a90048063e74f3fbb1161006a578063e74f3fbb14610171578063f2fde38b14610179578063f630ad1f1461019f578063fc0c546a146101a7578063fd75b8d4146101af576100a2565b80636d72c24e146100a7578063715018a6146100df57806384a198dc146100e95780638da5cb5b14610127578063ccb365b91461014b575b600080fd5b6100cd600480360360208110156100bd57600080fd5b5035600160a060020a03166101f3565b60408051918252519081900360200190f35b6100e7610211565b005b6100e7600480360360808110156100ff57600080fd5b50600160a060020a038135169060208101359061ffff604082013581169160600135166102c3565b61012f61065b565b60408051600160a060020a039092168252519081900360200190f35b6100e76004803603602081101561016157600080fd5b5035600160a060020a031661066a565b6100e76108de565b6100e76004803603602081101561018f57600080fd5b5035600160a060020a0316610ae5565b6100cd610bf0565b61012f610c06565b6101d5600480360360208110156101c557600080fd5b5035600160a060020a0316610c15565b6040805161ffff909316835260208301919091528051918290030190f35b600160a060020a031660009081526002602052604090206001015490565b610219610d77565b600054600160a060020a0390811691161461026c576040805160e560020a62461bcd028152602060048201819052602482015260008051602061107e833981519152604482015290519081900360640190fd5b60008054604051600160a060020a03909116907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e0908390a36000805473ffffffffffffffffffffffffffffffffffffffff19169055565b6102cb610d77565b600054600160a060020a0390811691161461031e576040805160e560020a62461bcd028152602060048201819052602482015260008051602061107e833981519152604482015290519081900360640190fd5b600160a060020a038416600090815260026020526040902060010154156103795760405160e560020a62461bcd0281526004018080602001828103825260288152602001806110356028913960400191505060405180910390fd5b610e428161ffff1611156103d7576040805160e560020a62461bcd02815260206004820152601b60248201527f436c6966662067726561746572207468616e2031302079656172730000000000604482015290519081900360640190fd5b6123a58261ffff161115610435576040805160e560020a62461bcd02815260206004820152601e60248201527f4475726174696f6e2067726561746572207468616e2032352079656172730000604482015290519081900360640190fd5b60006104458461ffff8516610d7b565b90506000811161049f576040805160e560020a62461bcd02815260206004820152601660248201527f616d6f756e74566573746564506572446179203e203000000000000000000000604482015290519081900360640190fd5b600154600160a060020a03166323b872dd6104b861065b565b6040805160e060020a63ffffffff8516028152600160a060020a039092166004830152306024830152604482018890525160648083019260209291908290030181600087803b15801561050a57600080fd5b505af115801561051e573d6000803e3d6000fd5b505050506040513d602081101561053457600080fd5b505161053f57600080fd5b610547610fc7565b6040518060c001604052808461ffff16620151800262ffffff16610569610dc6565b018152602080820188905261ffff808816604080850191909152600060608086018290526080808701839052600160a060020a03808f1660a098890181905280855260028089528686208b518155988b015160018a01558a8701519089018054958c01518916620100000263ffff0000199290991661ffff19909616959095171696909617909255870151600386015594860151600490940180549490951673ffffffffffffffffffffffffffffffffffffffff1990941693909317909355915192935090917f9a9851ada408f5d02ebd667e2ff6d5ff1a413d6a745d878e7cbbe00b42e6b23e9190a2505050505050565b600054600160a060020a031690565b610672610d77565b600054600160a060020a039081169116146106c5576040805160e560020a62461bcd028152602060048201819052602482015260008051602061107e833981519152604482015290519081900360640190fd5b600160a060020a038116600090815260026020526040812090806106e884610c15565b6003850154600186015492945090925060009161071091849161070a91610dca565b90610dca565b600154909150600160a060020a031663a9059cbb61072c61065b565b836040518363ffffffff1660e060020a0281526004018083600160a060020a0316815260200182815260200192505050602060405180830381600087803b15801561077657600080fd5b505af115801561078a573d6000803e3d6000fd5b505050506040513d60208110156107a057600080fd5b50516107ab57600080fd5b600154604080517fa9059cbb000000000000000000000000000000000000000000000000000000008152600160a060020a038881166004830152602482018690529151919092169163a9059cbb9160448083019260209291908290030181600087803b15801561081a57600080fd5b505af115801561082e573d6000803e3d6000fd5b505050506040513d602081101561084457600080fd5b505161084f57600080fd5b60008085556001850181905560028501805463ffffffff19169055600385015560048401805473ffffffffffffffffffffffffffffffffffffffff1916905560408051600160a060020a03871681526020810184905280820183905290517fc6870a34750128e89b4206e933b691be9b75add27afc68678e3bc9261d39f1449181900360600190a15050505050565b6000806108ea33610c15565b909250905080610944576040805160e560020a62461bcd02815260206004820152600b60248201527f5665737465642069732030000000000000000000000000000000000000000000604482015290519081900360640190fd5b336000908152600260208190526040909120908101546109729062010000900461ffff908116908516610e0c565b60028201805461ffff92909216620100000263ffff00001990921691909117905560038101546109a29083610e0c565b6003820155600154600480830154604080517fa9059cbb000000000000000000000000000000000000000000000000000000008152600160a060020a0392831693810193909352602483018690525192169163a9059cbb916044808201926020929091908290030181600087803b158015610a1c57600080fd5b505af1158015610a30573d6000803e3d6000fd5b505050506040513d6020811015610a4657600080fd5b5051610a9c576040805160e560020a62461bcd02815260206004820152600960248201527f6e6f20746f6b656e730000000000000000000000000000000000000000000000604482015290519081900360640190fd5b6004810154604080518481529051600160a060020a03909216917fc6cbb4aa8681b18644bf64921eea8f2b9f44cbd58d64fc07a110bfccc20382969181900360200190a2505050565b610aed610d77565b600054600160a060020a03908116911614610b40576040805160e560020a62461bcd028152602060048201819052602482015260008051602061107e833981519152604482015290519081900360640190fd5b600160a060020a038116610b885760405160e560020a62461bcd02815260040180806020018281038252602681526020018061100f6026913960400191505060405180910390fd5b60008054604051600160a060020a03808516939216917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e091a36000805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a0392909216919091179055565b3360009081526002602052604090206003015490565b600154600160a060020a031681565b600160a060020a03811660009081526002602052604081206001810154600382015483929111610c8f576040805160e560020a62461bcd02815260206004820152601360248201527f4772616e742066756c6c7920636c61696d656400000000000000000000000000604482015290519081900360640190fd5b8054610c99610dc6565b1015610cac576000809250925050610d72565b6000610cd062015180610cca6201518085600001540361070a610dc6565b90610d7b565b600283015490915061ffff168110610d16576000610cff83600301548460010154610dca90919063ffffffff16565b60029093015461ffff169450919250610d72915050565b6002820154600090610d3390839062010000900461ffff16610dca565b60028401546001850154919250600091610d509161ffff16610d7b565b90506000610d6261ffff841683610e69565b929650919450610d729350505050565b915091565b3390565b6000610dbd83836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f000000000000815250610ec5565b90505b92915050565b4290565b6000610dbd83836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f770000815250610f6a565b600082820183811015610dbd576040805160e560020a62461bcd02815260206004820152601b60248201527f536166654d6174683a206164646974696f6e206f766572666c6f770000000000604482015290519081900360640190fd5b600082610e7857506000610dc0565b82820282848281610e8557fe5b0414610dbd5760405160e560020a62461bcd02815260040180806020018281038252602181526020018061105d6021913960400191505060405180910390fd5b60008183610f545760405160e560020a62461bcd0281526004018080602001828103825283818151815260200191508051906020019080838360005b83811015610f19578181015183820152602001610f01565b50505050905090810190601f168015610f465780820380516001836020036101000a031916815260200191505b509250505060405180910390fd5b506000838581610f6057fe5b0495945050505050565b60008184841115610fbf5760405160e560020a62461bcd028152602060048201818152835160248401528351909283926044909101919085019080838360008315610f19578181015183820152602001610f01565b505050900390565b6040518060c001604052806000815260200160008152602001600061ffff168152602001600061ffff168152602001600081526020016000600160a060020a03168152509056fe4f776e61626c653a206e6577206f776e657220697320746865207a65726f20616464726573734772616e7420616c7265616479206578697374732c206d757374207265766f6b652066697273742e536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f774f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e6572a264697066735822122004b63f35a0c46b1a8fddce93afb5eb2c62cb22a270c3f980f1c2e82d7c1dd16364736f6c63430007040033",
        arguments: [window.token.options.address],
      })
      .send({
        from: accounts[0],
        gas: "1200000",
      })
      .on("error", function (error) {
        console.log(error);
        contractStatus.innerHTML = "Deployment Failed";
      })
      .on("confirmation", function (confirmationNumber, receipt) {
        if (confirmationNumber < 1) {
          console.log(confirmationNumber);
          console.log(receipt);
          contractStatus.innerHTML = "Contract Deployed";
        }
        vaultIsReady();
      })
      .then(function (newContractInstance) {
        window.contract.options.address = newContractInstance.options.address;
      });
  };

  deployUsingInput.onclick = async () => {
    const accounts = await ethereum.request({ method: "eth_accounts" });
    contractStatus.innerHTML = "Deploying";
    let isAddress;

    try {
      isAddress = web3.utils.toChecksumAddress(deployedTokenAddress.value);
    } catch (e) {
      console.error("invalid ethereum address", e.message);
      contractStatus.innerHTML = "invalid ethereum address";
    }
    if (isAddress) {
      await window.contract
      .deploy({
        data: "0x608060405234801561001057600080fd5b506040516111b03803806111b08339818101604052602081101561003357600080fd5b505160006100486401000000006100ca810204565b60008054600160a060020a031916600160a060020a0383169081178255604051929350917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e0908290a350600160a060020a0381166100a557600080fd5b60018054600160a060020a031916600160a060020a03929092169190911790556100ce565b3390565b6110d3806100dd6000396000f3fe608060405234801561001057600080fd5b50600436106100a25760003560e060020a90048063e74f3fbb1161006a578063e74f3fbb14610171578063f2fde38b14610179578063f630ad1f1461019f578063fc0c546a146101a7578063fd75b8d4146101af576100a2565b80636d72c24e146100a7578063715018a6146100df57806384a198dc146100e95780638da5cb5b14610127578063ccb365b91461014b575b600080fd5b6100cd600480360360208110156100bd57600080fd5b5035600160a060020a03166101f3565b60408051918252519081900360200190f35b6100e7610211565b005b6100e7600480360360808110156100ff57600080fd5b50600160a060020a038135169060208101359061ffff604082013581169160600135166102c3565b61012f61065b565b60408051600160a060020a039092168252519081900360200190f35b6100e76004803603602081101561016157600080fd5b5035600160a060020a031661066a565b6100e76108de565b6100e76004803603602081101561018f57600080fd5b5035600160a060020a0316610ae5565b6100cd610bf0565b61012f610c06565b6101d5600480360360208110156101c557600080fd5b5035600160a060020a0316610c15565b6040805161ffff909316835260208301919091528051918290030190f35b600160a060020a031660009081526002602052604090206001015490565b610219610d77565b600054600160a060020a0390811691161461026c576040805160e560020a62461bcd028152602060048201819052602482015260008051602061107e833981519152604482015290519081900360640190fd5b60008054604051600160a060020a03909116907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e0908390a36000805473ffffffffffffffffffffffffffffffffffffffff19169055565b6102cb610d77565b600054600160a060020a0390811691161461031e576040805160e560020a62461bcd028152602060048201819052602482015260008051602061107e833981519152604482015290519081900360640190fd5b600160a060020a038416600090815260026020526040902060010154156103795760405160e560020a62461bcd0281526004018080602001828103825260288152602001806110356028913960400191505060405180910390fd5b610e428161ffff1611156103d7576040805160e560020a62461bcd02815260206004820152601b60248201527f436c6966662067726561746572207468616e2031302079656172730000000000604482015290519081900360640190fd5b6123a58261ffff161115610435576040805160e560020a62461bcd02815260206004820152601e60248201527f4475726174696f6e2067726561746572207468616e2032352079656172730000604482015290519081900360640190fd5b60006104458461ffff8516610d7b565b90506000811161049f576040805160e560020a62461bcd02815260206004820152601660248201527f616d6f756e74566573746564506572446179203e203000000000000000000000604482015290519081900360640190fd5b600154600160a060020a03166323b872dd6104b861065b565b6040805160e060020a63ffffffff8516028152600160a060020a039092166004830152306024830152604482018890525160648083019260209291908290030181600087803b15801561050a57600080fd5b505af115801561051e573d6000803e3d6000fd5b505050506040513d602081101561053457600080fd5b505161053f57600080fd5b610547610fc7565b6040518060c001604052808461ffff16620151800262ffffff16610569610dc6565b018152602080820188905261ffff808816604080850191909152600060608086018290526080808701839052600160a060020a03808f1660a098890181905280855260028089528686208b518155988b015160018a01558a8701519089018054958c01518916620100000263ffff0000199290991661ffff19909616959095171696909617909255870151600386015594860151600490940180549490951673ffffffffffffffffffffffffffffffffffffffff1990941693909317909355915192935090917f9a9851ada408f5d02ebd667e2ff6d5ff1a413d6a745d878e7cbbe00b42e6b23e9190a2505050505050565b600054600160a060020a031690565b610672610d77565b600054600160a060020a039081169116146106c5576040805160e560020a62461bcd028152602060048201819052602482015260008051602061107e833981519152604482015290519081900360640190fd5b600160a060020a038116600090815260026020526040812090806106e884610c15565b6003850154600186015492945090925060009161071091849161070a91610dca565b90610dca565b600154909150600160a060020a031663a9059cbb61072c61065b565b836040518363ffffffff1660e060020a0281526004018083600160a060020a0316815260200182815260200192505050602060405180830381600087803b15801561077657600080fd5b505af115801561078a573d6000803e3d6000fd5b505050506040513d60208110156107a057600080fd5b50516107ab57600080fd5b600154604080517fa9059cbb000000000000000000000000000000000000000000000000000000008152600160a060020a038881166004830152602482018690529151919092169163a9059cbb9160448083019260209291908290030181600087803b15801561081a57600080fd5b505af115801561082e573d6000803e3d6000fd5b505050506040513d602081101561084457600080fd5b505161084f57600080fd5b60008085556001850181905560028501805463ffffffff19169055600385015560048401805473ffffffffffffffffffffffffffffffffffffffff1916905560408051600160a060020a03871681526020810184905280820183905290517fc6870a34750128e89b4206e933b691be9b75add27afc68678e3bc9261d39f1449181900360600190a15050505050565b6000806108ea33610c15565b909250905080610944576040805160e560020a62461bcd02815260206004820152600b60248201527f5665737465642069732030000000000000000000000000000000000000000000604482015290519081900360640190fd5b336000908152600260208190526040909120908101546109729062010000900461ffff908116908516610e0c565b60028201805461ffff92909216620100000263ffff00001990921691909117905560038101546109a29083610e0c565b6003820155600154600480830154604080517fa9059cbb000000000000000000000000000000000000000000000000000000008152600160a060020a0392831693810193909352602483018690525192169163a9059cbb916044808201926020929091908290030181600087803b158015610a1c57600080fd5b505af1158015610a30573d6000803e3d6000fd5b505050506040513d6020811015610a4657600080fd5b5051610a9c576040805160e560020a62461bcd02815260206004820152600960248201527f6e6f20746f6b656e730000000000000000000000000000000000000000000000604482015290519081900360640190fd5b6004810154604080518481529051600160a060020a03909216917fc6cbb4aa8681b18644bf64921eea8f2b9f44cbd58d64fc07a110bfccc20382969181900360200190a2505050565b610aed610d77565b600054600160a060020a03908116911614610b40576040805160e560020a62461bcd028152602060048201819052602482015260008051602061107e833981519152604482015290519081900360640190fd5b600160a060020a038116610b885760405160e560020a62461bcd02815260040180806020018281038252602681526020018061100f6026913960400191505060405180910390fd5b60008054604051600160a060020a03808516939216917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e091a36000805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a0392909216919091179055565b3360009081526002602052604090206003015490565b600154600160a060020a031681565b600160a060020a03811660009081526002602052604081206001810154600382015483929111610c8f576040805160e560020a62461bcd02815260206004820152601360248201527f4772616e742066756c6c7920636c61696d656400000000000000000000000000604482015290519081900360640190fd5b8054610c99610dc6565b1015610cac576000809250925050610d72565b6000610cd062015180610cca6201518085600001540361070a610dc6565b90610d7b565b600283015490915061ffff168110610d16576000610cff83600301548460010154610dca90919063ffffffff16565b60029093015461ffff169450919250610d72915050565b6002820154600090610d3390839062010000900461ffff16610dca565b60028401546001850154919250600091610d509161ffff16610d7b565b90506000610d6261ffff841683610e69565b929650919450610d729350505050565b915091565b3390565b6000610dbd83836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f000000000000815250610ec5565b90505b92915050565b4290565b6000610dbd83836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f770000815250610f6a565b600082820183811015610dbd576040805160e560020a62461bcd02815260206004820152601b60248201527f536166654d6174683a206164646974696f6e206f766572666c6f770000000000604482015290519081900360640190fd5b600082610e7857506000610dc0565b82820282848281610e8557fe5b0414610dbd5760405160e560020a62461bcd02815260040180806020018281038252602181526020018061105d6021913960400191505060405180910390fd5b60008183610f545760405160e560020a62461bcd0281526004018080602001828103825283818151815260200191508051906020019080838360005b83811015610f19578181015183820152602001610f01565b50505050905090810190601f168015610f465780820380516001836020036101000a031916815260200191505b509250505060405180910390fd5b506000838581610f6057fe5b0495945050505050565b60008184841115610fbf5760405160e560020a62461bcd028152602060048201818152835160248401528351909283926044909101919085019080838360008315610f19578181015183820152602001610f01565b505050900390565b6040518060c001604052806000815260200160008152602001600061ffff168152602001600061ffff168152602001600081526020016000600160a060020a03168152509056fe4f776e61626c653a206e6577206f776e657220697320746865207a65726f20616464726573734772616e7420616c7265616479206578697374732c206d757374207265766f6b652066697273742e536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f774f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e6572a264697066735822122004b63f35a0c46b1a8fddce93afb5eb2c62cb22a270c3f980f1c2e82d7c1dd16364736f6c63430007040033",
        arguments: [deployedTokenAddress.value],
      })
      .send({
        from: accounts[0],
        gas: "1200000",
      })
      .on("error", function (error) {
        console.log(error);
        contractStatus.innerHTML = "Deployment Failed";
      })
      .on("confirmation", function (confirmationNumber, receipt) {
        if (confirmationNumber < 1) {
          console.log(confirmationNumber);
          console.log(receipt);
          contractStatus.innerHTML = "Contract Deployed";
        }
        vaultIsReady();
      })
      .then(function (newContractInstance) {
        window.contract.options.address = newContractInstance.options.address;
        window.token.options.address = deployedTokenAddress.value;
        tokenAddress.innerHTML = deployedTokenAddress.value;
      });
    };
  };

  loadVault.onclick = async () => {
    contractStatus.innerHTML = "Fetching existing Vault";
    let isAddress;

    try {
      isAddress = web3.utils.toChecksumAddress(exisitngVaultAddress.value);
    } catch (e) {
      console.error("invalid ethereum address", e.message);
      contractStatus.innerHTML = "invalid ethereum address";
    };
    if(isAddress){
      try
      {window.contract.options.address = exisitngVaultAddress.value;
        contractStatus.innerHTML = "VestingVault Ready";
        window.token.options.address = await window.contract.methods.token().call();
        tokenAddress.innerHTML = window.token.options.address;        
        vaultIsReady();
      } catch (e) {
        console.error("invalid vault address", e.message);
        contractStatus.innerHTML = "invalid Vault address";
      };
      
    };
  };

  async function vaultIsReady() {
    const accounts = await ethereum.request({ method: "eth_accounts" });

    createToken.disabled = true;
    deployButton.disabled = true;
    deployUsingInput.disabled = true;
    loadVault.disabled = true;
    revokeGrant.disabled = false;
    fetchGrant.disabled = false;
    claimGrant.disabled = false;

    if(await window.token.methods.allowance(accounts[0], window.contract.options.address).call() == 0){
      approve.disabled = false;
      createNewGrant.disabled = true;
    } else { 
      approve.disabled = true; 
      createNewGrant.disabled = false;
    };

  };

  //
  // Manage Grants Section
  //

  approve.onclick = async () => {
    contractStatus.innerHTML = "Approving VestingVault";
    const accounts = await ethereum.request({ method: "eth_accounts" });
    
      await window.token.methods
      .approve(window.contract.options.address, web3.utils.toWei('10000000000', 'ether'))
      .send({from: accounts[0]})
      .on("error", function (error) {
        console.log(error);
        contractStatus.innerHTML = "Approval Failed";
      })
      .on("confirmation", function (confirmationNumber, receipt) {
        if (confirmationNumber < 1) {
          console.log(confirmationNumber);
          console.log(receipt);
          contractStatus.innerHTML = "VestingVault Approved";
        }
      })
      .then(function () {
        approve.disabled = true; 
        createNewGrant.disabled = false;
      });  
  };

  createNewGrant.onclick = async () => {
    contractStatus.innerHTML = "Creating New Grant";
    const accounts = await ethereum.request({ method: "eth_accounts" });

    let isAddress;

    try {
      isAddress = web3.utils.toChecksumAddress(setGrantAddress.value);
    } catch (e) {
      console.error("invalid ethereum address", e.message);
      contractStatus.innerHTML = "invalid ethereum address";
    };

    if(isAddress){
      await window.contract.methods
      .addTokenGrant(setGrantAddress.value, web3.utils.toWei(setGrantAmount.value,'ether'),setDays.value, 0)
      .send({from: accounts[0]})
      .on("error", function (error) {
        console.log(error);
        contractStatus.innerHTML = "Failed to create new Grant";
      })
      .on("confirmation", function (confirmationNumber, receipt) {
        if (confirmationNumber < 1) {
          console.log(confirmationNumber);
          console.log(receipt);
          contractStatus.innerHTML = "New Grant Created";
        }
      })
      .then(async function () {
        if(await window.token.methods.allowance(accounts[0], window.contract.options.address).call() == 0){
          approve.disabled = false;
          createNewGrant.disabled = true;
          approve.innerHTML = "Approve VestingVault";
        };
      });
    };
    
  };

  revokeGrant.onclick = async () => {
    contractStatus.innerHTML = "Revoking Grant";
    const accounts = await ethereum.request({ method: "eth_accounts" });

    let isAddress;

    try {
      isAddress = web3.utils.toChecksumAddress(granteeAddress.value);
    } catch (e) {
      console.error("invalid ethereum address", e.message);
      contractStatus.innerHTML = "invalid ethereum address";
    };

    if(isAddress){
      await window.contract.methods
      .revokeTokenGrant(granteeAddress.value)
      .send({from: accounts[0]})
      .on("error", function (error) {
        console.log(error);
        contractStatus.innerHTML = "Failed to Revoke Grant";
      })
      .on("confirmation", function (confirmationNumber, receipt) {
        if (confirmationNumber < 1) {
          console.log(confirmationNumber);
          console.log(receipt);
        }
      })
      .then(async function () {
        contractStatus.innerHTML = "Grant Revoked";
      });
    };

  };

  //
  // Claim Vested Grant Section
  //

  fetchGrant.onclick = async () => {
    contractStatus.innerHTML = "Fetching Data";
    const accounts = await ethereum.request({ method: "eth_accounts" });
    lockedGrant.innerHTML = "";
    unlockedGrant.innerHTML = "";
    alreadyClaimed.innerHTML = "";

    try{
      const claimed = await window.contract.methods.fetchGrantData().call({from: accounts[0]});
      const total = await window.contract.methods.getGrantAmount(accounts[0]).call();
      const claimData = await window.contract.methods.calculateGrantClaim(accounts[0]).call();
      const base = 10**18;

      lockedGrant.innerHTML = (total - claimed - claimData['1'])/base;
      unlockedGrant.innerHTML = claimData['1']/base;
      alreadyClaimed.innerHTML = claimed/base;

      contractStatus.innerHTML = "Data Fetched";

    } catch (e) {
      console.log(e);
      if(await window.contract.methods.getGrantAmount(accounts[0]).call() == 0){
        contractStatus.innerHTML = "No Grant Available";
        lockedGrant.innerHTML = 0;
        unlockedGrant.innerHTML = 0;
        alreadyClaimed.innerHTML = 0;
      } else {
        contractStatus.innerHTML = "Failed to Fetch Data";
      };
    };
  };

  claimGrant.onclick = async () => {
    contractStatus.innerHTML = "Claiming Grant";
    const accounts = await ethereum.request({ method: "eth_accounts" });

    await window.contract.methods.claimVestedTokens().send({from: accounts[0]})
    .on("error", function (error) {
      console.log(error);
      contractStatus.innerHTML = "Failed to Claim Grant";
    })
    .on("confirmation", function (confirmationNumber, receipt) {
      if (confirmationNumber < 1) {
        console.log(confirmationNumber);
        console.log(receipt);
      }
    })
    .then(async function () {
      contractStatus.innerHTML = "Grant Claimed";
      try{
        const claimed = await window.contract.methods.fetchGrantData().call({from: accounts[0]});
        const total = await window.contract.methods.getGrantAmount(accounts[0]).call();
        const claimData = await window.contract.methods.calculateGrantClaim(accounts[0]).call();
        const base = 10**18;
  
        lockedGrant.innerHTML = (total - claimed - claimData['1'])/base;
        unlockedGrant.innerHTML = claimData['1']/base;
        alreadyClaimed.innerHTML = claimed/base;
  
      } catch (e) {
        console.log(e);
        if(await window.contract.methods.getGrantAmount(accounts[0]).call() == 0){
          contractStatus.innerHTML = "No Grant Available";
          lockedGrant.innerHTML = 0;
          unlockedGrant.innerHTML = 0;
          alreadyClaimed.innerHTML = 0;
        } else {
          contractStatus.innerHTML = "Failed to Fetch Data";
        };
      };
    });
  };

};

window.addEventListener("DOMContentLoaded", initialize);
